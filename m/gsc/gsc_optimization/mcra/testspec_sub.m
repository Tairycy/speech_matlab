clear
clc
fs = 16000;

NoiseMcra1.first  = 1;
NoiseMcra1.len    = 129;
NoiseMcra1.w    = 1;
NoiseMcra1.L    = 60;
NoiseMcra1.alpha    = 0.85;
NoiseMcra1.frm_cnt    = 0;
NoiseMcra1.S   = zeros(1, NoiseMcra1.len);
NoiseMcra1.Smin   = zeros(1, NoiseMcra1.len);
NoiseMcra1.Stmp   = zeros(1, NoiseMcra1.len);
NoiseMcra1.Yprob   = zeros(1, NoiseMcra1.len);
NoiseMcra1.lamda_d   = zeros(1, NoiseMcra1.len);
NoiseMcra1.b   = zeros(1, 2*NoiseMcra1.w+1);    %hanning window coefficients
NoiseMcra1.b = 0.5 * (1 - cos(2 * pi * (1:2*NoiseMcra1.w+1) / (2*NoiseMcra1.w+2)));
NoiseMcra1.b = NoiseMcra1.b ./ sum(NoiseMcra1.b);

alafa0 = 2;
s = 1/10;  

energy_data = zeros(1,NoiseMcra1.len);

FrameLen = 256;
FrameInc = FrameLen / 2;
hamm_win = hamming(FrameLen);

noi_spec = zeros(1, NoiseMcra1.len);
lastsig = zeros(1, FrameLen/2);
FrameNum = 100;

hwt = waitbar(0, 'spe process');
for p = 1 : FrameNum
    waitbar(p/FrameNum, hwt);
    
    sig_mic = [
        81.4723686393179;
        90.5791937075619;
        12.6986816293506;
        91.3375856139019;
        63.2359246225410;
        9.75404049994095;
        27.8498218867048;
        54.6881519204984;
        95.7506835434298;
        96.4888535199277;
        15.7613081677548;
        97.0592781760616;
        95.7166948242946;
        48.5375648722841;
        80.0280468888800;
        14.1886338627215;
        42.1761282626275;
        91.5735525189067;
        79.2207329559554;
        95.9492426392903;
        65.5740699156587;
        3.57116785741896;
        84.9129305868777;
        93.3993247757551;
        67.8735154857774;
        75.7740130578333;
        74.3132468124916;
        39.2227019534168;
        65.5477890177557;
        17.1186687811562;
        70.6046088019609;
        3.18328463774207;
        27.6922984960890;
        4.61713906311539;
        9.71317812358475;
        82.3457828327293;
        69.4828622975817;
        31.7099480060861;
        95.0222048838355;
        3.44460805029088;
        43.8744359656398;
        38.1558457093008;
        76.5516788149002;
        79.5199901137063;
        18.6872604554379;
        48.9764395788231;
        44.5586200710900;
        64.6313010111265;
        70.9364830858073;
        75.4686681982361;
        27.6025076998578;
        67.9702676853675;
        65.5098003973841;
        16.2611735194631;
        11.8997681558377;
        49.8364051982143;
        95.9743958516081;
        34.0385726666133;
        58.5267750979777;
        22.3811939491137;
        75.1267059305653;
        25.5095115459269;
        50.5957051665142;
        69.9076722656686;
        89.0903252535799;
        95.9291425205444;
        54.7215529963803;
        13.8624442828679;
        14.9294005559057;
        25.7508254123736;
        84.0717255983663;
        25.4282178971531;
        81.4284826068816;
        24.3524968724989;
        92.9263623187228;
        34.9983765984809;
        19.6595250431208;
        25.1083857976031;
        61.6044676146639;
        47.3288848902729;
        35.1659507062997;
        83.0828627896291;
        58.5264091152724;
        54.9723608291140;
        91.7193663829810;
        28.5839018820374;
        75.7200229110721;
        75.3729094278495;
        38.0445846975357;
        56.7821640725221;
        7.58542895630636;
        5.39501186666072;
        53.0797553008973;
        77.9167230102011;
        93.4010684229183;
        12.9906208473730;
        56.8823660872193;
        46.9390641058206;
        1.19020695012414;
        33.7122644398882;
        16.2182308193243;
        79.4284540683907;
        31.1215042044805;
        52.8533135506213;
        16.5648729499781;
        60.1981941401637;
        26.2971284540144;
        65.4079098476782;
        68.9214503140008;
        74.8151592823709;
        45.0541598502498;
        8.38213779969326;
        22.8976968716819;
        91.3337361501670;
        15.2378018969223;
        82.5816977489547;
        53.8342435260057;
        99.6134716626885;
        7.81755287531837;
        44.2678269775446;
        10.6652770180584;
        96.1898080855054;
        0.463422413406744;
        77.4910464711502;
        81.7303220653433;
        86.8694705363510;
        8.44358455109103;
        39.9782649098896;
        25.9870402850654;
        80.0068480224308;
        43.1413827463545;
        91.0647594429523;
        18.1847028302853;
        26.3802916521990;
        14.5538980384717;
        13.6068558708664;
        86.9292207640089;
        57.9704587365570;
        54.9860201836332;
        14.4954798223727;
        85.3031117721894;
        62.2055131485066;
        35.0952380892271;
        51.3249539867053;
        40.1808033751942;
        7.59666916908419;
        23.9916153553658;
        12.3318934835166;
        18.3907788282417;
        23.9952525664903;
        41.7267069084370;
        4.96544303257421;
        90.2716109915281;
        94.4787189721646;
        49.0864092468080;
        48.9252638400019;
        33.7719409821377;
        90.0053846417662;
        36.9246781120215;
        11.1202755293787;
        78.0252068321138;
        38.9738836961253;
        24.1691285913833;
        40.3912145588115;
        9.64545251683886;
        13.1973292606335;
        94.2050590775485;
        95.6134540229802;
        57.5208595078466;
        5.97795429471558;
        23.4779913372406;
        35.3158571222071;
        82.1194040197959;
        1.54034376515551;
        4.30238016578078;
        16.8990029462704;
        64.9115474956452;
        73.1722385658670;
        64.7745963136307;
        45.0923706430945;
        54.7008892286345;
        29.6320805607773;
        74.4692807074156;
        18.8955015032545;
        68.6775433365315;
        18.3511155737270;
        36.8484596490337;
        62.5618560729690;
        78.0227435151377;
        8.11257688657853;
        92.9385970968730;
        77.5712678608402;
        48.6791632403172;
        43.5858588580919;
        44.6783749429806;
        30.6349472016557;
        50.8508655381127;
        51.0771564172110;
        81.7627708322262;
        79.4831416883453;
        64.4318130193692;
        37.8609382660268;
        81.1580458282477;
        53.2825588799455;
        35.0727103576883;
        93.9001561999887;
        87.5942811492984;
        55.0156342898422;
        62.2475086001228;
        58.7044704531417;
        20.7742292733028;
        30.1246330279491;
        47.0923348517591;
        23.0488160211559;
        84.4308792695389;
        19.4764289567049;
        22.5921780972399;
        17.0708047147859;
        22.7664297816554;
        43.5698684103899;
        31.1102286650413;
        92.3379642103244;
        43.0207391329584;
        18.4816320124136;
        90.4880968679893;
        97.9748378356085;
        43.8869973126103;
        11.1119223440599;
        25.8064695912067;
        40.8719846112552;
        59.4896074008614;
        26.2211747780845;
        60.2843089382083;
        71.1215780433683;
        22.1746734017240;
        11.7417650855806;
        29.6675873218327;
        31.8778301925882;
        42.4166759713807;
        50.7858284661118;
        8.55157970900440;
        26.2482234698333;
        80.1014622769739;
        2.92202775621463;
        92.8854139478045;
        73.0330862855453;
        48.8608973803579;
        57.8525061023439;
        23.7283579771521;
        45.8848828179931;
        96.3088539286913;
        54.6805718738968;
        52.1135830804002;
        23.1594386708524;
        48.8897743920167;
        62.4060088173690];
    
    fft_data = (fft(sig_mic));
    half_fftdata = fft_data(1 : NoiseMcra1.len);
    energy_data = 0.8 * energy_data + 0.2 * abs(half_fftdata)';
    
    [noi_spec, NoiseMcra1] = mcra(abs(half_fftdata)',NoiseMcra1);
    
    snr = 10 * log10((energy_data .^ 2) ./ (noi_spec .^ 2));
    
    alafa = alafa0 - s * snr;
    alafa = max(alafa,1);
    alafa = min(alafa,3);
    
    yizhi(:,p) = max((energy_data - alafa .* noi_spec),0) ./ (energy_data + eps);
    yizhi(:,p) = max(yizhi(:,p),0.01);
    
%     for i = 1 : 5
%         if(p > 1)
%             yizhi(i,p) = 0.8 * yizhi(i,p - 1) + 0.2 * yizhi(i,p);
%         end
%     end

    f_sig(: ,p) = (yizhi(:,p) .* half_fftdata);
    qqqqq = 1;
end

% xout1 = istft(f_sig,FrameLen,0.5 * FrameLen,1);
% audiowrite('out1.wav',int16(result),fs);
close(hwt)
fclose('all');